@Service
@Slf4j
public class FlowConfigLaunchService {
    
    private final FlowConfigService flowConfigService;
    private final FlowConfigLaunchExecutor launchExecutor;
    private final SimulationService simulationService;
    private final FlowConfigRepository flowConfigRepository;
    private final TransactionTemplate transactionTemplate;
    
    public FlowConfigLaunchService(FlowConfigService flowConfigService,
                                 FlowConfigLaunchExecutor launchExecutor,
                                 SimulationService simulationService,
                                 FlowConfigRepository flowConfigRepository,
                                 TransactionTemplate transactionTemplate) {
        this.flowConfigService = flowConfigService;
        this.launchExecutor = launchExecutor;
        this.simulationService = simulationService;
        this.flowConfigRepository = flowConfigRepository;
        this.transactionTemplate = transactionTemplate;
    }
    
    @Async("launchTaskExecutor")
    public CompletableFuture<Void> launchAll(long id) throws TemplateException, AppServerException, IOException, AppUserException {
        log.info("Running launch-all-Async for id: {}", id);
        
        return CompletableFuture.runAsync(() -> {
            transactionTemplate.execute(status -> {
                try {
                    executeLaunchProcess(id);
                    return null;
                } catch (Exception e) {
                    status.setRollbackOnly();
                    throw new RuntimeException("Launch process failed for ID: " + id, e);
                }
            });
        });
    }
    
    private void executeLaunchProcess(long id) throws Exception {
        clearLogFile(id);
        
        FlowConfig flowConfig = validateAndGetFlowConfig(id);
        
        if (isSimulationRequired(flowConfig)) {
            executeSimulationTest(id, flowConfig);
        }
        
        executeLaunchStages(id, flowConfig);
    }
    
    private FlowConfig validateAndGetFlowConfig(long id) {
        FlowConfig flowConfig = flowConfigService.getFlowConfigEntityById(id);  
        if (flowConfig == null) {  
            throw new RuntimeException("FlowConfig with ID " + id + " not found");
        }  
        return flowConfig;
    }
    
    private boolean isSimulationRequired(FlowConfig flowConfig) {
        return flowConfig.getConfigSettings() != null && 
               flowConfig.getConfigSettings().isSimulationTest();
    }
    
    private void executeSimulationTest(long id, FlowConfig flowConfig) {
        log.info("Simulation test is enabled for FlowConfig ID: {}", id);
        flowConfigService.writeToLog(id, "Simulation test is enabled for FlowConfig ID: " + id);
        
        List<String> switchConfigurations = flowConfig.getConfigSettings().getSwitchConfiguration();
        
        if (switchConfigurations == null || switchConfigurations.isEmpty()) {
            String errorMessage = "Switch configurations are missing for simulation test";
            flowConfigService.writeToLog(id, errorMessage);
            throw new RuntimeException(errorMessage);
        }
        
        log.info("Starting simulation test for FlowConfig ID: {}", id);
        flowConfigService.writeToLog(id, "Starting simulation test for FlowConfig ID: " + id);
        
        String simulationStatus = simulationService.simulateConfiguration(switchConfigurations);
        
        if (!"SUCCESS".equals(simulationStatus)) {
            String errorMessage = "Simulation Test Failed for FlowConfig ID: " + id + ". Status: " + simulationStatus;
            flowConfigService.writeToLog(id, errorMessage);
            throw new RuntimeException(errorMessage);
        }
        
        log.info("Simulation test completed successfully for FlowConfig ID: {}", id);
        flowConfigService.writeToLog(id, "Simulation test completed successfully for FlowConfig ID: " + id);
    }
    
    private void executeLaunchStages(long id, FlowConfig flowConfig) throws Exception {
        // This status update is part of the main transaction
        updateLaunchStatus(id, FlowConfig.Status.IN_PROGRESS, "Launch process started for FlowConfig ID: " + id);
        
        try {
            // Execute stages
            executePreCheckStage(id);
            executeSwitchConfigStage(id);
            
            if (hasPostCheckData(id)) {
                executePostCheckStage(id);
                executeResultDiffStage(id);
            } else {
                handleMissingPostCheckData(id);
            }
            
            // Final success processing
            completeSuccessfulLaunch(id, flowConfig);
            
        } catch (Exception ex) {
            handleLaunchFailure(id, flowConfig, ex);
            throw ex;
        }
    }
    
    private void executePreCheckStage(long id) throws Exception {
        flowConfigService.writeToLog(id, "Starting Pre-Check stage for FlowConfig ID: " + id);
        flowConfigService.updateStatusServiceVerificationPre(id, FlowConfig.Status.IN_PROGRESS);
        
        try {
            launchExecutor.runPreCheck(id, "2", true);
            flowConfigService.updateStatusServiceVerificationPre(id, FlowConfig.Status.SUCCESS);
            flowConfigService.writeToLog(id, "Pre-Check stage completed successfully for FlowConfig ID: " + id);
        } catch (Exception ex) {
            flowConfigService.updateStatusServiceVerificationPre(id, FlowConfig.Status.FAIL);
            flowConfigService.writeToLog(id, "Pre-Check stage failed for FlowConfig ID: " + id + ". Error: " + ex.getMessage());
            throw ex;
        }
    }
    
    private void executeSwitchConfigStage(long id) throws Exception {
        flowConfigService.writeToLog(id, "Starting Switch Config Update stage for FlowConfig ID: " + id);
        flowConfigService.updateStatusConfigSetting(id, FlowConfig.Status.IN_PROGRESS);
        
        try {
            launchExecutor.updateSwitchConfig(id, true);
            flowConfigService.updateStatusConfigSetting(id, FlowConfig.Status.SUCCESS);
            flowConfigService.writeToLog(id, "Switch Config Update stage completed successfully for FlowConfig ID: " + id);
        } catch (Exception ex) {
            flowConfigService.updateStatusConfigSetting(id, FlowConfig.Status.FAIL);
            flowConfigService.writeToLog(id, "Switch Config Update stage failed for FlowConfig ID: " + id + ". Error: " + ex.getMessage());
            throw ex;
        }
    }
    
    private void executePostCheckStage(long id) throws Exception {
        FlowConfigPostCheckRequestDTO postCheckRequestDTO = buildPostCheckRequest(id);
        
        flowConfigService.writeToLog(id, "Starting Post-Check stage for FlowConfig ID: " + id);
        flowConfigService.updateStatusServiceVerificationPost(id, FlowConfig.Status.IN_PROGRESS);
        
        try {
            launchExecutor.runPostCheck(id, postCheckRequestDTO, "2", true);
            flowConfigService.updateStatusServiceVerificationPost(id, FlowConfig.Status.SUCCESS);
            flowConfigService.writeToLog(id, "Post-Check stage completed successfully for FlowConfig ID: " + id);
        } catch (Exception ex) {
            flowConfigService.updateStatusServiceVerificationPost(id, FlowConfig.Status.FAIL);
            flowConfigService.writeToLog(id, "Post-Check stage failed for FlowConfig ID: " + id + ". Error: " + ex.getMessage());
            throw ex;
        }
    }
    
    private void executeResultDiffStage(long id) throws Exception {
        flowConfigService.writeToLog(id, "Starting Result-Diff stage for FlowConfig ID: " + id);
        flowConfigService.updateStatusResultDiff(id, FlowConfig.Status.IN_PROGRESS);
        
        try {
            launchExecutor.processResultDiff(id, true);
            flowConfigService.updateStatusResultDiff(id, FlowConfig.Status.SUCCESS);
            flowConfigService.writeToLog(id, "Result-Diff stage completed successfully for FlowConfig ID: " + id);
        } catch (Exception ex) {
            flowConfigService.updateStatusResultDiff(id, FlowConfig.Status.FAIL);
            flowConfigService.writeToLog(id, "Result-Diff stage failed for FlowConfig ID: " + id + ". Error: " + ex.getMessage());
            throw ex;
        }
    }
    
    private FlowConfigPostCheckRequestDTO buildPostCheckRequest(long id) {
        FlowConfigFullResponseDTO flowConfigDTO = flowConfigService.getFlowConfigById(id);
        ServiceVerificationAfterDTO serviceVerificationAfter = flowConfigDTO.getData().getServiceVerificationAfter();
        
        FlowConfigPostCheckDataDTO dataDTO = FlowConfigPostCheckDataDTO.builder()
                .normalDeterminationCriteriaDtoList(serviceVerificationAfter.getNormalDeterminationCriteria())
                .build();
        
        return FlowConfigPostCheckRequestDTO.builder()
                .data(dataDTO)
                .build();
    }
    
    private boolean hasPostCheckData(long id) {
        FlowConfigFullResponseDTO flowConfigDTO = flowConfigService.getFlowConfigById(id);
        return flowConfigDTO.getData().getServiceVerificationAfter() != null;
    }
    
    private void handleMissingPostCheckData(long id) {
        log.warn("ServiceVerificationAfter is null for flowConfig ID: {}. Skipping post-check and result-diff.", id);
        flowConfigService.writeToLog(id, "ServiceVerificationAfter data is null. Skipping Post-Check and Result-Diff stages");
        
        flowConfigService.updateStatusServiceVerificationPost(id, FlowConfig.Status.NOT_EXECUTED);
        flowConfigService.updateStatusResultDiff(id, FlowConfig.Status.NOT_EXECUTED);
    }
    
    private void completeSuccessfulLaunch(long id, FlowConfig flowConfig) {
        flowConfig.setExecuted(true);
        flowConfig.setExecutedTime(LocalDateTime.now());
        flowConfig.setStatusLaunch(FlowConfig.Status.SUCCESS);
        flowConfigService.updateFlowConfigWithoutDeviceConfigs(id, flowConfig);
        flowConfigService.writeToLog(id, "Launch process completed successfully for FlowConfig ID: " + id);
    }
    
    private void handleLaunchFailure(long id, FlowConfig flowConfig, Exception ex) {
        flowConfig.setStatusLaunch(FlowConfig.Status.FAIL);
        flowConfigService.updateFlowConfigWithoutDeviceConfigs(id, flowConfig);
        flowConfigService.writeToLog(id, "Launch process failed for FlowConfig ID: " + id + ". Error: " + ex.getMessage());
    }
    
    private void updateLaunchStatus(long id, FlowConfig.Status status, String logMessage) {
        flowConfigService.updateStatusLaunch(id, status);
        flowConfigService.writeToLog(id, logMessage);
    }
    
    private void clearLogFile(long id) {
        // Your existing implementation
    }
}
